syntax = "proto3";

package analysis;

// 프론트엔드용이라 go_package 옵션은 무시되지만, 포맷 유지를 위해 둠
option go_package = "github.com/vanillaturtlechips/silver-guardian/backend/proto";

service AnalysisService {
  rpc StartAnalysis(AnalysisRequest) returns (AnalysisResponse);
  rpc StreamProgress(ProgressRequest) returns (stream ProgressEvent);
  rpc GetResult(ResultRequest) returns (AnalysisResult);
  rpc CancelAnalysis(CancelRequest) returns (CancelResponse);

  // [NEW] Auth & User RPCs
  rpc LoginWithGoogle (LoginRequest) returns (LoginResponse);
  rpc GetUserProfile (GetProfileRequest) returns (UserProfileResponse);
  rpc GetUserHistory (GetHistoryRequest) returns (HistoryResponse);
}

message AnalysisRequest {
  string video_url = 1;
  AnalysisOptions options = 2;
  string user_id = 3; 
}

message AnalysisOptions {
  int32 sensitivity = 1;
  bool analyze_comments = 2;
  int32 top_comments_count = 3;
}

message AnalysisResponse {
  string job_id = 1;
  string status = 2;
  string message = 3;
}

message ProgressRequest {
  string job_id = 1;
}

message ProgressEvent {
  string job_id = 1;
  string type = 2;
  string message = 3;
  int32 progress = 4;
  string timestamp = 5;
}

message ResultRequest {
  string job_id = 1;
}

message AnalysisResult {
  string job_id = 1;
  string video_id = 2;
  VideoMetadata metadata = 3;
  int32 safety_score = 4;
  repeated string categories = 5;
  string gemini_response = 6;
  repeated Comment top_comments = 7;
  string status = 8;
  string created_at = 9;
  string completed_at = 10;
}

message VideoMetadata {
  string title = 1;
  string description = 2;
  string channel = 3;
  int64 duration = 4;
  int64 view_count = 5;
  string published_at = 6;
}

message Comment {
  string author = 1;
  string text = 2;
  int64 likes = 3;
  int32 rank = 4;
}

message CancelRequest {
  string job_id = 1;
}

message CancelResponse {
  string job_id = 1;
  bool cancelled = 2;
  string message = 3;
}

// --- [NEW] Auth & User Messages ---

message LoginRequest {
  string id_token = 1;
}

message LoginResponse {
  string access_token = 1;
  User user = 2;
}

message GetProfileRequest {
  string user_id = 1;
}

message UserProfileResponse {
  User user = 1;
  Subscription subscription = 2;
}

message GetHistoryRequest {
  string user_id = 1;
  int32 page = 2;
  int32 page_size = 3;
}

message HistoryResponse {
  repeated HistoryItem items = 1;
}

message User {
  int64 id = 1;
  string email = 2;
  string name = 3;
  string picture_url = 4;
}

message Subscription {
  string plan_type = 1;
  string start_date = 2;
  string end_date = 3;
}

message HistoryItem {
  string video_id = 1;
  string video_title = 2;
  string thumbnail_url = 3;
  string analyzed_at = 4;
}